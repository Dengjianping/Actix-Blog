{% extends "base.html" %}

{% block title %}{{ post.title }}{% endblock title %}

{% block head %}
    <script>
        $(document).ready(function(e) {
            showdown.setFlavor('github');
            // showdown.setOption('omitExtraWLInCodeBlocks', true);
            // console.log(showdown.getOptions());
            // cannot use body | safe here to render markdown due to escape problem
            // I have to hide the body div first, then get the markdown back, then use showdown to handle.
            // it looks template engine issue, tera
            // console.log(document.getElementById('#markdown').innerHTML);
            var md = $('#markdown').text().trimLeft(); // there're lots of empty space ahead of markdown
            // console.log(md);
            $('#markdown').empty();
            var converter = new showdown.Converter();
            html = converter.makeHtml(md);
            $('#markdown').append(html);
            $('#markdown').show();

            $("#like").click(function(event, data){
                var n = $("#count").text();
                n = parseInt(n) + 1;
                $.ajax({
                    type: "POST",
                    url: "/user_likes/",
                    contentType: "application/json; charset=utf-8;",
                    data: JSON.stringify({'likes_count': n}), // must use stringify to serialize json data
                    timeout: 10000,
                    success: function() {
                        if (data)
                            $("#count").text(n);
                    }
                })
            });

            $("#sendMessageButton").click(function(event, data){
                event.preventDefault();
                var username = $("#username").val();
                var email = $("#email").val();
                var comment_content = $("#comment_content").val();
                $.ajax({
                    type: "POST",
                    url: "/add_comment/",
                    contentType: "application/json; charset=utf-8;",
                    data: JSON.stringify({'username': username, 'email': email, 'comment': comment_content}), // must use stringify to serialize json data
                    timeout: 10000,
                    success: function(data) {
                        var insert = "<li class='float-left'><div class='panel-heading'><strong>" + username + 
                                    " commented on </strong> <span class='text-muted'>"+ Date() + 
                                    "</span></div><div class='panel-body'>" + comment_content + "</div></li>";
                        $('#comments_list').append(insert);
                    },
                    error: function(data) {
                        console.log('error happened.')
                        console.log(data);
                    }
                })
            });
        })
    </script>
{% endblock head %}

{% block content %}
    <!-- Page Header -->
    {% if post %}
    <header class="masthead" style="background-image: url('img/about-bg.jpg')">
        <div class="overlay"></div>
        <div class="container">
            <div class="row">
            <div class="col-lg-8 col-md-10 mx-auto">
                <div class="page-heading">
                <h1>{{ post.title }}</h1>
                <span class="subheading">posted on {{ post.publish | date(format="%Y-%m-%d") }}</span>
                </div>
            </div>
            </div>
        </div>
    </header>

    <article>
    <div class="container">
        <div class="row">
            <!-- I have to use the style, due to tera cannot get variable in aera <script></script> -->
            <div class="col-lg-8 col-md-10 mx-auto" id="markdown" style="display:none;">
            {{ post.body | safe }}
            </div>
            <div class="col-lg-4 col-md-2 mx-auto">
                <button class="btn btn-primary" id="like">Like
                    <span class="badge" id="count">{{ post.likes }}</span>
                </button>
            </div>
        </div>
    </div>
    </article>
    {% else %}
    <p>cannot find post.</p>
    {% endif %}

    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-md-10 mx-auto">
                <div class="page-header float-left">
                    <h3 class="float-left">Comments</h1>
                </div>
                <br>
                <ul class="list-group float-left" id="comments_list">
                    {% if comments %}
                    {% for comment in comments %}
                    <li class="float-left">
                        <div class="panel-heading">
                            <strong>{{ comment.username }} commented on </strong> <span class="text-muted">{{ comment.committed_time | date(format="%Y-%m-%d") }}</span>
                        </div>
                        <div class="panel-body">
                            {{ comment.comment }}
                        </div>
                    </li>
                    {% endfor %}
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-6 col-md-6 mx-auto">
        <form name="sentComment" id="commentForm">
            <div class="control-group">
                <div class="form-group floating-label-form-group controls">
                    <label>Name</label>
                    <input type="text" class="form-control" placeholder="Name" id="username" required data-validation-required-message="Please enter your name.">
                    <p class="help-block text-danger"></p>
                </div>
            </div>
            <div class="control-group">
                <div class="form-group floating-label-form-group controls">
                    <label>Email Address</label>
                    <input type="email" class="form-control" placeholder="Email Address" id="email" required data-validation-required-message="Please enter your email address.">
                    <p class="help-block text-danger"></p>
                </div>
            </div>
            <div class="control-group">
                <div class="form-group floating-label-form-group controls">
                    <label>Comment</label>
                    <textarea rows="5" class="form-control" placeholder="Message" id="comment_content" required data-validation-required-message="Please enter a message."></textarea>
                    <p class="help-block text-danger"></p>
                </div>
            </div>
            <br>
            <div id="success"></div>
            <div class="form-group">
                <button type="submit" class="btn btn-primary" id="sendMessageButton">Add</button>
            </div>
        </form>
        </div>
    </div>

{% endblock content %}